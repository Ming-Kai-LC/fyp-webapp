{% extends 'appointments/base.html' %}
{% load crispy_forms_tags %}

{% block page_title %}Book Appointment{% endblock %}
{% block appointments_title %}Book New Appointment{% endblock %}

{% block page_description %}
<p class="text-muted">Schedule an appointment with a doctor for consultation or follow-up.</p>
{% endblock %}

{% block appointments_content %}
<div class="row">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="bi bi-calendar-plus"></i> Appointment Details</h5>
            </div>
            <div class="card-body">
                <form method="post" id="bookingForm">
                    {% csrf_token %}
                    {{ form|crispy }}

                    <div class="alert alert-info" id="slotsInfo" style="display: none;">
                        <h6><i class="bi bi-info-circle"></i> Available Slots</h6>
                        <div id="availableSlots"></div>
                    </div>

                    <div class="mt-4">
                        <button type="submit" class="btn btn-primary btn-lg">
                            <i class="bi bi-check-circle"></i> Book Appointment
                        </button>
                        <a href="{% url 'appointments:my_appointments' %}" class="btn btn-outline-secondary btn-lg">
                            <i class="bi bi-x-circle"></i> Cancel
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <div class="card mb-3">
            <div class="card-header bg-info text-white">
                <h6 class="mb-0"><i class="bi bi-question-circle"></i> Booking Tips</h6>
            </div>
            <div class="card-body">
                <ul class="list-unstyled mb-0">
                    <li class="mb-2">
                        <i class="bi bi-check-circle-fill text-success"></i>
                        Select your preferred doctor
                    </li>
                    <li class="mb-2">
                        <i class="bi bi-check-circle-fill text-success"></i>
                        Choose a convenient date and time
                    </li>
                    <li class="mb-2">
                        <i class="bi bi-check-circle-fill text-success"></i>
                        Provide detailed reason for visit
                    </li>
                    <li class="mb-2">
                        <i class="bi bi-check-circle-fill text-success"></i>
                        You'll receive a confirmation email
                    </li>
                    <li class="mb-0">
                        <i class="bi bi-check-circle-fill text-success"></i>
                        Reminders will be sent before appointment
                    </li>
                </ul>
            </div>
        </div>

        <div class="card">
            <div class="card-header bg-warning text-dark">
                <h6 class="mb-0"><i class="bi bi-exclamation-triangle"></i> Important</h6>
            </div>
            <div class="card-body">
                <p class="mb-2"><small>
                    <strong>Cancellation Policy:</strong> Please cancel at least 24 hours before your appointment.
                </small></p>
                <p class="mb-0"><small>
                    <strong>Late Policy:</strong> Please arrive 10-15 minutes before your scheduled time.
                </small></p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const doctorField = document.querySelector('[name="doctor"]');
    const dateField = document.querySelector('[name="appointment_date"]');
    const timeField = document.querySelector('[name="appointment_time"]');
    const slotsInfo = document.getElementById('slotsInfo');
    const availableSlots = document.getElementById('availableSlots');

    function fetchAvailableSlots() {
        const doctorId = doctorField.value;
        const date = dateField.value;

        if (!doctorId || !date) {
            slotsInfo.style.display = 'none';
            return;
        }

        fetch(`{% url 'appointments:available_slots_api' %}?doctor_id=${doctorId}&date=${date}`)
            .then(response => response.json())
            .then(data => {
                if (data.slots && data.slots.length > 0) {
                    let html = '<div class="row g-2">';
                    data.slots.forEach(slot => {
                        html += `
                            <div class="col-6 col-md-4">
                                <button type="button" class="btn btn-outline-primary btn-sm w-100 slot-btn"
                                        data-time="${slot.time}">
                                    ${slot.time_display}
                                </button>
                            </div>
                        `;
                    });
                    html += '</div>';
                    availableSlots.innerHTML = html;
                    slotsInfo.style.display = 'block';

                    // Add click event to slot buttons
                    document.querySelectorAll('.slot-btn').forEach(btn => {
                        btn.addEventListener('click', function() {
                            timeField.value = this.dataset.time;
                            document.querySelectorAll('.slot-btn').forEach(b => b.classList.remove('active'));
                            this.classList.add('active');
                        });
                    });
                } else {
                    availableSlots.innerHTML = '<p class="text-warning mb-0">No available slots for this date.</p>';
                    slotsInfo.style.display = 'block';
                }
            })
            .catch(error => {
                console.error('Error fetching slots:', error);
                slotsInfo.style.display = 'none';
            });
    }

    if (doctorField && dateField) {
        doctorField.addEventListener('change', fetchAvailableSlots);
        dateField.addEventListener('change', fetchAvailableSlots);
    }
});
</script>
{% endblock %}
